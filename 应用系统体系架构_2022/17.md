# 17-`MYSQL Backup and Recovery`

- **冗灾能力**：冗，指的就是实现**备份**。`master-slave`架构实现备份的写时候的同步。

- **备份的类型**：主要是逻辑备份(只会备份用于创建数据表的`SQL`语句)与物理备份(直接复制整张表)，全量备份与增量备份等。

- **逻辑备份与物理备份的区别**：

  - 逻辑备份占用空间要大于物理备份，因为还要额外存储一些关键字字段。因而前者更适用于小数据。
  - 逻辑备份直接复制的是标准`SQL`语句，因而其可迁移性更强。

- **在线备份与离线备份**：

  - 在线备份又被称作热备份，即在备份过程中不会终止应用程序的运行。但是在线备份会增大表的负载，并且需要多次加锁来保证备份的一致性。但是对于用户的更加友好
  - 离线备份又被称作冷备份，即在备份过程中应用程序会被暂停。
  - 或许可以类比于最近讲的那个编译器的垃圾回收？？？
  - 对两者进行一种中和：即使用**暖备份**。即在进行备份过程中应用不会停止，但是只允许读取数据不允许修改数据。

- **快照备份**：`copy-on-write`.但是`MYSQL`没有自主提供快照备份。

- **全量备份和增量备份**：全量备份指的是在一个给定的时间点对于当前系统中所有文件的状态进行备份，增量备份指的是在两次全量备份之间的某个时间点进行的对于相对于上一次全量备份数据修改部分的一次记录和备份。`MYSQL`中使用`binary log`进行增量备份。(主要是记录在这段时间用户执行的`SQL`语句。)

- `binary log`采用**滚动写**的方式，即每个`log`的文件大小是有上限的，当到达上限的时候，就在一个新的`log`文件中写入`SQL`语句。

- 几种常见的`crash`:

  - 操作系统崩溃。
  - 断电。
  - 文件系统崩溃。
  - 硬件故障。

- 对于上述几种可能的崩溃情况，对于操作系统崩溃以及断电，`MYSQL`可以保证通过备份正常回复，因为用于备份的文件没有损失。之后通过`redo-undo`策略来进行恢复。而对于后面两种，若崩溃的部分影响了`log`内容，则可能会出现无法回复甚至无法启动的问题。

- **利用全量增量备份进行数据恢复的简单步骤**：

  - 首先在某一时刻进行全量备份，即将当前时刻数据库中所有状态导入一个`sql`文件，之后每隔固定时间再进行一次全量备份。
  - 在两次全量备份之间，每过一段时间使用`log`文件来记录从这次增量备份到上次增量备份/全量备份之间用户新执行的`sql`语句，并每经过固定次数的增量备份之后将这些`log`合并到上一次全量备份的文件中去，并删除这些`log`文件来腾出空间。
  - 在进行下一次全量备份的时候，将上一次全量备份的文件重新导出并与最近一次增量备份合并之后就可以得到新的全量备份文件。
  - 在这种情况下，若想恢复到两次全量备份中间的某个状态，则只需要先回复最近的前一次全量备份，之后在恢复在这次全量备份到目标时间段内的所有的还没有被合并到全量文件中的增量备份`log`文件。
  - 但是回复完最近的一次增量备份之后还是不能能够保证一定能完全恢复到目标时间点，因为增量备份是周期性记录的，而要恢复的时间可能并不是那个进行周期记录的时间。所以就需要将在这段时间内的`log`文件进行一次单独的恢复。这也就要求**需要将用于备份的`log`文件存储在一个不同于文件目录的安全位置上**。
  - 对于想要跳过某一条或几条错误执行的指令的情况，则主要步骤与前面基本相同，但是需要额外的去找到要跳过指令的其实和终止位置，并且跳过这段指令继续向下恢复即可。

- `mysqldump`的基本用法：

  ```sql
  copy 一个数据库：
  shell> mysqldump db1 > dump.sql 
  shell> mysqladmin create db2 
  shell> mysql db2 < dump.sql
  在复制数据库的时候不要添加--databases参数，因为这个参数会包含USE DB1这行语句，使得rename失效。
  进行不同server的copy：
  On Server 1:
  shell> mysqldump --databases db1 > dump.sql
  Copy the dump file from Server 1 to Server 2.
  On Server 2:
  shell> mysql < dump.sql
  
  Alternatively, you can omit --databases from the mysqldump command. 
  On Server 1:
  shell> mysqldump db1 > dump.sql
  On Server 2:
  shell> mysqladmin create db1 
  shell> mysql db1 < dump.sql
  ```

- **`MYSQL`中的`stored programs`**:包括`stored procedures, events, triggers, functions`。这些东西的可移植性很差，因为会使用很多与`DBMS`相关的内容来写代码，并且`SQL`虽然有标准，但是不同数据库可能存在方言。所以导出可能也不会起作用。

- 