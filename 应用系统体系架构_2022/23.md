# 23-`Clustering`

- 一个`large-scale`的系统的特征：
  - 用户多，服务器分在各地。
  - `long-running`,容错好。
  - 单位时间内会产生大量的数据，单机情况下负载大。
  - 可以很好的进行负载均衡，并且正确的进行业务隔离，能够将关键事务与一般事务分开始处理，从而保障系统的可用性和安全性，如将支付系统与展示系统分开。
  - 由多人共同管理。
- 大规模系统的必须的特性：
  - `reliablity`:可靠性，即系统在正常运行情况下不会产生危害。
  - `availiblity`:可用性，指的是系统可以持续正常运行，不会以为某些节点故障而出现不可使用的情况，但是可用性只会保证能否使用，而不会保证服务的质量。
  - `serviceablity`:可服务性，更强调提供的服务的质量。
  - `scality`:可拓展性。
- 为了满足上述特性，需要**集群**：
  - 集群应该是由一组**松耦合**的服务器组成的。不能完全解耦，因为需要进行主从同步之类的操作。
  - 通过添加**冗余**来满足可靠性，可用性，可服务性，可拓展性。
    - 通过备份消除单一故障节点来保证可靠性。
    - 通过增加节点数量来降低一个节点故障对系统的影响来保证可用性。
    - 通过增加硬件来增加可拓展性。
- 集群中几种负载均衡策略：
  - `round-rabin`:指的是每一个节点得到请求的概率均等，并按照一定顺序不断循环。但是这种方式在请求具有个性化的时候不会很好用，即只有一个节点能够做某个操作的时候，这样循环就不合理。
  - `least-connection/load`:即每次选取当前工作负载最小的节点作为请求的处理者。可以根据请求到来的时候各个节点的连接数来大致确定负载的大小。
  - `IP-Hashing`:根据对于请求发出者`IP`进行哈希的结果来确定目标节点。这样的话同一个`IP`的请求一定是在同一台机器上面。但是这种方式很依赖于一个好的哈希函数，否则可能会导致大量请求都被定位到同一个节点上面。
- `session stickness`(会话粘滞性)：
  - 指的是一个新请求创建的时候会在一个节点上面创建一个新的`session`，由于之后的操作需要在同一个`session`上执行，所以会使得同一用户的同一组请求都会被重定向到同一个`server`上去执行。而这会使得前面提到的`round-robin`和`least-connection`失效。
- 对上述负载均衡的一种优化：添加一个**会话服务器**，专门存储某一个创建过的`session`，这样的话一个节点需要一个`session`的时候通过与会话服务器的交互来获取具体的`session`。这样的话就很大程度上解决了会话粘滞性，并且使得上述三种策略更好运作。
- 集群的容错：
  - 请求级别容错：即一个请求已经转发到一个节点的时候，该节点崩溃，那么需要通过将这个请求转移到其他节点上继续执行的方式来解决这种错误进行容错。
  - 会话容错：指的是由于节点崩溃而使得`session`丢失的情况。这种情况下，一种解决方案是在创建一个`session`的时候就进行一次备份，一种是添加一个会话服务器节点。
- `Nginx`(一个常用的负载均衡服务器):
- 代理：即许多`IP`通过一个统一的代理`IP`向外访问；反向代理：大量请求在到来时通过反向代理服务器来负载均衡到不同的节点。
- `MYSQL Clustering`：
  - 需要安装`MYSQL Shell`。
  - 首先配置集群机器属性：`dba.configureInstance()`。
  - 使用`db.createCluster()`来创建一个新的集群(需要通过`groupSeeds`来制定种子)，并且将运行这个指令的节点作为第一个初始的`primary`节点(可读可写，一般从属节点只能读)。
  - 使用`db.addInstance()`向集群中添加新的节点。当一个新的节点加入集群的是胡，一般通过**克隆**的方式来进行数据的同步。添加成功之后，通过`status()`来查看状态。
  - 可以使用`CheckInstanceState()`来检查节点的状态，包括`OK New`(不执行任何事务),`OK Recoverable`(在执行事务，并且和种子节点的事务不会冲突),`ERROR Diverged`(在执行事务，与其他事务发生了冲突),`ERROR lost_transaction`四种。
  - 可以支持单个主节点和多个主节点两种模式。多个主节点可以实现高并发的写，但是需要大量额外的同步来保证一致性，一般使用单个主节点的模式。
  - 在单个主节点的模式下，如果要产生新的主节点，一种是通过`instance`参数直接设置，一种是不加额外的参数，而是通过**在添加节点时设置的权重来选择**，默认选择权重**最大**的一个。若剩余节点权重相同，则选择最小`UUID`的那一个。
- 